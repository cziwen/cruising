# 2.8 昼夜系统（Day Night System）

## 2.8.1 概述

昼夜系统负责管理游戏内的时间流逝、昼夜循环、季节变化和天体位置计算。系统使用统一的 dt（delta time）增量更新机制，确保所有时间相关系统精确同步。

## 2.8.2 核心要素

### 时间单位
- **游戏分钟**：基础时间单位，一天1440分钟（24小时）
- **游戏小时**：60游戏分钟 = 1游戏小时
- **游戏天**：1440游戏分钟 = 1游戏天
- **现实时间换算**：1现实秒 = 1游戏小时 = 60游戏分钟

### 时间比例
- **基础时间比例（timeScale）**：60.0
  - 1现实秒 = 60游戏分钟 = 1游戏小时
- **时间倍数（timeMultiplier）**：可调整的倍数（0.1x - 10.0x）
  - 用于调试，加快或减慢游戏时间
  - 默认值：1.0x（正常速度）

### 昼夜周期
- **一天时长**：1440游戏分钟（24游戏小时）
- **白天时段**：6:00 - 18:00（360 - 1080分钟）
- **夜晚时段**：18:00 - 6:00（1080 - 360分钟）
- **默认起始时间**：6:00（日出）

### 季节系统
- **一年天数**：120天
- **季节数量**：4个季节（春、夏、秋、冬）
- **每季节天数**：30天
- **季节顺序**：春 → 夏 → 秋 → 冬 → 循环

## 2.8.3 时间更新机制

### dt 增量更新
系统使用 dt（delta time）增量方式更新，每帧精确计算：

```dart
dtGameMinutes = dtRealSeconds * timeScale * timeMultiplier
```

- `dtRealSeconds`：实际经过的秒数（每帧增量）
- `timeScale`：基础时间比例（60.0）
- `timeMultiplier`：时间倍数（0.1 - 10.0）

### 累积时间
- 使用 `_accumulatedGameMinutes` 累积游戏内时间（精确到分钟）
- 每帧更新累积值
- 整数分钟数用于显示和逻辑判断

### 暂停/恢复
- **暂停**：`pause()` - 停止时间流逝
- **恢复**：`resume()` - 恢复时间流逝
- **使用场景**：
  - 在港口时暂停时间
  - 在海上时恢复时间

## 2.8.4 时间显示

### 当前时间
- **格式**：HH:00（只显示小时，分钟固定为00）
- **计算**：基于累积的游戏内时间
- **更新**：实时更新（通过 AnimatedBuilder）

### 当前日期
- **格式**：季节 + 日期（如"春 15日"）
- **计算**：基于当前天数（1-120）
- **季节判断**：根据天数计算当前季节

### 时间显示位置
- **UI层**：左上角时间显示组件
- **参考**：详见 `2.5 ui_system.md`

## 2.8.5 昼夜判断

### 白天/夜晚判断
- **白天**：`isDaytime` - 6:00 到 18:00
- **夜晚**：`isNighttime` - 18:00 到 6:00
- **计算**：基于累积时间在一天中的位置

### 昼夜周期进度
- **范围**：0.0 - 1.0
- **0.0**：日出（6:00）
- **0.5**：日落（18:00）
- **1.0**：下一个日出
- **用途**：用于计算太阳/月亮位置和透明度

## 2.8.6 天体系统

### 太阳/月亮位置
- **计算器**：`CelestialBodyPosition`
- **轨迹**：弧形轨迹（从右到左）
- **太阳**：白天显示（0.0 - 0.5 进度）
- **月亮**：夜晚显示（0.5 - 1.0 进度）

### 位置计算
- **X坐标**：从右到左线性移动
- **Y坐标**：弧形轨迹（使用正弦函数）
- **参数**：
  - 弧形高度：屏幕高度的25%
  - 中心Y：屏幕上方15%再调高50像素
  - 起始X：屏幕右侧外
  - 结束X：屏幕左侧外

### 透明度计算
- **太阳**：
  - 日出时淡入（0.0 - 0.1）
  - 正午完全显示（0.1 - 0.4）
  - 日落时淡出（0.4 - 0.5）
  - 夜晚完全隐藏（0.5 - 1.0）
- **月亮**：
  - 月出时淡入（0.5 - 0.6）
  - 午夜完全显示（0.6 - 0.9）
  - 月落时淡出（0.9 - 1.0）
  - 白天完全隐藏（0.0 - 0.5）

### 天体层位置
- **渲染层**：Layer 0.5（天体层）
- **参考**：详见 `2.6 scene_system.md`

## 2.8.7 日期系统

### 日期跟踪
- **当前日期**：1 - 120（一年）
- **跨年处理**：超过120天后重置为1
- **日期增加**：每天00:00时自动增加

### 季节计算
- **春季**：第1-30天
- **夏季**：第31-60天
- **秋季**：第61-90天
- **冬季**：第91-120天

### 季节日期
- **格式**：季节名称 + 日期（如"春 15日"）
- **计算**：当前日期在季节中的位置（1-30）

## 2.8.8 时间事件

### 午夜跨越检测
- **触发时机**：从23:00跨越到00:00
- **用途**：
  - 触发工资结算
  - 触发酒馆船员刷新
  - 增加日期
  - 检查价格更新（每7天）

### 工资结算
- **触发**：每天00:00
- **处理**：在 `GameState` 中处理
- **参考**：详见 `2.4 crew_system.md`

### 价格更新
- **触发**：每7天
- **处理**：在 `GameState` 中处理
- **参考**：详见 `2.1 trade_system.md`

## 2.8.9 技术实现

### 核心类
- **DayNightSystem**：昼夜系统管理器
- **CelestialBodyPosition**：天体位置计算器

### 主要方法
```dart
// 时间更新
bool updateWithDeltaTime(double dtRealSeconds)

// 时间控制
void pause()
void resume()
void setTimeMultiplier(double multiplier)

// 时间查询
String get currentTime
int get currentHour
int get currentMinute
bool get isDaytime
bool get isNighttime
double get dayCycleProgress
Season get currentSeason
String get seasonDateString
```

### 状态管理
- 时间状态在 `GameState` 中管理
- 通过 `notifyListeners()` 通知UI更新
- UI通过 `AnimatedBuilder` 响应时间变化

## 2.8.10 与游戏系统的关系

### 场景系统
- 提供昼夜周期进度，用于计算天体位置
- 天体层（Layer 0.5）显示太阳/月亮
- **参考**：`2.6 scene_system.md`

### UI系统
- 提供当前时间，用于时间显示组件
- 时间显示位于左上角（Layer 3.5）
- **参考**：`2.5 ui_system.md`

### 导航系统
- 时间流逝影响航行进度（如果基于游戏时间）
- 航行时时间继续流逝
- **参考**：`2.2 navigation_system.md`

### 船员系统
- 每天00:00触发工资结算
- 每天00:00刷新港口酒馆的可招募船员
- 时间倍数影响结算和刷新频率
- **参考**：`2.4 crew_system.md`

### 贸易系统
- 每7天触发价格更新
- 时间倍数影响价格更新频率
- **参考**：`2.1 trade_system.md`

### 调试系统
- 提供时间倍数调整功能
- 时间倍数直接影响昼夜系统更新速度
- **参考**：`2.7 debug_system.md`

## 2.8.11 数据模型

### DayNightSystem
```dart
class DayNightSystem {
  // 时间状态
  int gameMinutes
  double timeMultiplier
  bool isPaused
  int currentDay
  
  // 时间查询
  String currentTime
  int currentHour
  int currentMinute
  bool isDaytime
  bool isNighttime
  double dayCycleProgress
  Season currentSeason
  String seasonDateString
  
  // 时间控制
  void setGameMinutes(int value)
  void pause()
  void resume()
  void setTimeMultiplier(double multiplier)
  bool updateWithDeltaTime(double dtRealSeconds)
  void reset()
}
```

### Season 枚举
```dart
enum Season {
  spring('春'),
  summer('夏'),
  autumn('秋'),
  winter('冬');
}
```

### CelestialBodyPosition
```dart
class CelestialBodyPosition {
  // 计算天体位置
  static Offset calculatePosition(
    double progress,
    double screenWidth,
    double screenHeight,
    bool isDaytime,
  )
  
  // 计算透明度
  static double getOpacity(double progress, bool isDaytime)
}
```

## 2.8.12 常量配置

### 时间常量
```dart
static const int minutesPerDay = 1440        // 一天1440分钟
static const int daysPerSeason = 30          // 每季节30天
static const int daysPerYear = 120            // 一年120天
static const int dayDurationMinutes = 720    // 白天12小时
static const int nightDurationMinutes = 720  // 夜晚12小时
static const double timeScale = 60.0          // 基础时间比例
```

### 时间范围
- **时间倍数**：0.1x - 10.0x
- **日期范围**：1 - 120（循环）
- **小时范围**：0 - 23
- **分钟范围**：0 - 59

---

**最后更新**：2024年（昼夜系统实现）

