# 2.4 船员系统（Crew System）

## 2.4.1 概述
船员系统管理船上的船员，通过分配不同职业的船员来提供各种加成效果。船员可以提升航速、自动修理船只耐久度、以及提高开炮速度。每个船员都有三项技能值和工资，玩家需要合理分配职业以最大化收益。

## 2.4.2 核心要素

### 船员属性
- **姓名（Name）**：船员的名称
- **水手技能（SailorSkill）**：0-10（上限10），影响航速加成（技能值直接对应增加的节数，例如：技能值5 = 增加5节）
- **船工技能（ShipwrightSkill）**：0-10（上限10），影响自动修理效率（技能值直接对应每秒恢复的耐久数，例如：技能值5 = 每秒5点）
- **炮手技能（GunnerSkill）**：0-10（上限10），影响开炮速度（技能值直接对应每秒炮数，例如：技能值5 = 每秒5炮）
- **工资（Salary）**：每天需要支付的金币
- **头像路径（AvatarPath）**：可选的头像图片路径
- **分配职业（AssignedRole）**：当前分配的职业角色

**注意**：所有技能值上限为10，使用曲线公式生成，保留小数点后2位。详见下方"技能值生成公式"。

### 船员职业
1. **水手（Sailor）** ⛵
   - 提供航速加成（以节为单位）
   - 根据水手技能值计算增加的节数
   - 计算公式：增加的节数 = 所有水手的sailorSkill总和（技能值直接对应节数）

2. **船工（Shipwright）** 🔧
   - 提供自动修理能力
   - 根据船工技能值计算每秒恢复的耐久度

3. **炮手（Gunner）** 🔫
   - 提供开炮速度加成
   - 根据炮手技能值计算每秒可发射的炮数

4. **未分配（Unassigned）** ❌
   - 默认状态，不提供任何加成

### 船员限制
- **最大船员数**：默认5人（可在GameState中配置）
- **工资成本**：每天需要支付所有船员的工资总和

## 2.4.3 加成系统

### 航速加成
- **计算公式**：`增加的节数 = 所有水手的sailorSkill总和`（技能值直接对应节数，技能值上限10）
- **效果**：直接增加船只的航行速度（节），缩短航行时间
- **示例**：
  - 3个水手，技能值分别为 1.50、2.30、1.80，总技能值 5.60 → 增加 5.60 节
  - 最终航速 = 基础速度8节 + 5.60节 = 13.60节
  - 由于水手技能值上限为10且曲度较高（a=10），单个水手很难达到高技能值
  - 需要多个水手才能显著提升航速
  - **无上限限制**：航速加成没有上限，理论上可以通过招募大量水手无限提升航速
- **实现**：在GameState中，航速加成直接返回节数（保留小数），加到基础速度上
- **单位**：加成以"节"为单位显示（保留2位小数）
- **对航行时间的影响**：航速越高，航行时间越短。例如：距离192节，航速从8节提升到20节，航行时间从24小时减少到约9.6小时（详见下方"节对航行时间的影响"）

### 自动修理
- **计算公式**：`每秒恢复耐久 = 所有船工的shipwrightSkill总和`（技能值直接对应每秒恢复的耐久数，技能值上限10）
- **效果**：每秒自动恢复船只耐久度
- **示例**：2个船工，技能值分别为 6.40、7.20，总技能值 13.60 → 每秒恢复 13.60 点耐久
- **实现**：使用 dt 增量方式更新（每帧检查），根据经过的时间自动恢复耐久
- **触发机制**：累积现实时间达到1秒时，计算修复量 = 修理效率 × 累积时间，然后一次性恢复。例如：技能值5.00 = 每秒5点，累积1秒后恢复5点
- **战斗中生效**：船工的自动修理在战斗中仍然有效（详见 `2.9 combat_system.md`）
- **特性**：由于船工曲度较低（a=2），更容易获得高技能值船工，修理效果更明显

### 开炮速度
- **计算公式**：`每秒炮数 = 所有炮手的gunnerSkill总和`（技能值直接对应每秒炮数，技能值上限10）
- **效果**：提高开炮频率
- **示例**：2个炮手，技能值分别为 2.62、3.10，总技能值 5.72 → 每秒可发射 5.72 炮（需要累积到约0.17秒才能发射一炮）
- **实现**：使用 dt 增量方式更新（每帧检查），累积时间达到触发间隔时发射
- **触发机制**：累积时间达到触发间隔时发射，例如：技能值5.00 = 每秒5炮 = 0.2秒/炮
- **战斗中使用**：战斗系统使用此值计算玩家攻击频率（详见 `2.9 combat_system.md`）
- **特性**：炮手曲度中等（a=6），技能值分布介于水手和船工之间

## 2.4.4 船员管理

### 添加船员
- 通过`addCrewMember(CrewMember member)`方法添加
- 检查是否超过最大船员数限制
- 添加后自动清除缓存，重新计算加成

### 移除船员
- 通过`removeCrewMember(CrewMember member)`方法移除
- 移除后自动清除缓存，重新计算加成

### 分配职业
- 通过`assignCrewRole(CrewMember member, CrewRole role)`方法分配
- 可以随时更改船员的职业分配
- 分配后自动清除缓存，重新计算加成

### 缓存机制
- 使用缓存避免重复计算加成值
- 当船员列表或分配发生变化时，自动清除缓存
- 缓存包括：
  - 按职业分组的船员列表
  - 航速加成值
  - 自动修理效率
  - 开炮速度
  - 总工资

## 2.4.5 界面设计

### 船员管理对话框
- **标题栏**：显示"船员管理"标题和关闭按钮
- **统计区域**：
  - 显示各职业的船员数量（水手、船工、炮手）
  - 显示综合效果（航速加成、自动修理、开炮速度）
- **船员列表**：
  - 显示所有船员的详细信息
  - 每个船员卡片包含：
    - 头像（或占位符）
    - 姓名和工资
    - 三项技能值（水手、船工、炮手）
    - 职业分配下拉选择器

### 船员卡片布局
```
┌─────────────────────────────────┐
│  [头像] 姓名          工资：30/天│
│  ⛵ 70  🔧 20  🔫 10          │
│  分配为：[职业选择器]            │
└─────────────────────────────────┘
```

### 职业选择
- 使用下拉菜单选择职业
- 显示职业图标和名称
- 选择后立即更新加成效果

### 港口酒馆对话框
- **标题栏**：显示"港口酒馆 Tavern"标题和关闭按钮
- **左右分栏布局**：
  - 左侧（2/5宽度）：可滚动的船员列表
  - 右侧（3/5宽度）：选中船员的详细信息
- **列表项**：
  - 小头像、姓名
  - 三项技能值（⛵🔧🔫）和工资
  - 点击选中，高亮显示
- **详情区域**：
  - 大头像（120×120）
  - 姓名和工资
  - 技能详情（每项技能单独一行）
  - 角色描述文本
  - 招募按钮和取消按钮
- **招募确认对话框**：
  - 显示工资、招募费用、当前船员数
  - 确认招募 / 再看看 按钮

## 2.4.6 系统流程

### 招募船员
1. 玩家在港口酒馆界面 → 查看可招募的船员列表
2. 点击列表项 → 查看选中船员的详细信息（技能值、工资、描述等）
3. 点击"招募船员"按钮 → 弹出确认对话框
4. 确认招募 → 扣除招募费用（工资 × 10），添加到船员列表
5. 前往船员管理界面 → 分配职业以提供加成

### 管理船员
1. 打开船员管理界面 → 查看当前船员和加成效果
2. 调整职业分配 → 通过下拉菜单重新分配
3. 查看效果变化 → 加成值实时更新
4. 确认分配 → 保存更改

### 自动修理流程
1. 主游戏循环每帧调用 → 使用 dt 增量方式更新（现实时间）
2. 计算修理效率 → 根据船工总技能值（每秒恢复的耐久数）
3. 累积修理时间 → 累积现实时间（秒）
4. 每秒恢复一次 → 当累积时间达到1秒时，计算修复量 = 修理效率 × 累积时间，然后一次性恢复
5. 不超过最大耐久度 → 限制在最大值内
6. **战斗中继续生效**：战斗时自动修理仍然有效，但战斗系统使用游戏时间增量更新（详见 `2.9 combat_system.md`）

## 2.4.7 数据模型

### 船员（CrewMember）
- `name`: 船员名称（String）
- `sailorSkill`: 水手技能 0-10（double，保留2位小数）
- `shipwrightSkill`: 船工技能 0-10（double，保留2位小数）
- `gunnerSkill`: 炮手技能 0-10（double，保留2位小数）
- `salary`: 工资（每天）（int）
- `avatarPath`: 头像路径（可选，String?）
- `assignedRole`: 分配的职业（CrewRole）

**注意**：技能值类型从 `int` 改为 `double`，以支持小数点后2位的精度。技能值上限为10，使用曲线公式生成。

### 船员职业（CrewRole）
- `sailor`: 水手 ⛵
- `shipwright`: 船工 🔧
- `gunner`: 炮手 🔫
- `unassigned`: 未分配 ❌

### 船员管理器（ShipCrewManager）
- `crewMembers`: 船员列表（只读）
- `addCrewMember()`: 添加船员
- `removeCrewMember()`: 移除船员
- `assignCrewRole()`: 分配职业
- `getCrewByRole()`: 获取指定职业的船员列表
- `calculateSailingBonus()`: 计算航速加成
- `calculateAutoRepair()`: 计算自动修理效率
- `calculateFireRateBonus()`: 计算开炮速度
- `calculateTotalSalary()`: 计算总工资
- `getSailorCount()`: 获取水手数量
- `getShipwrightCount()`: 获取船工数量
- `getGunnerCount()`: 获取炮手数量

## 2.4.8 加成计算说明

### 技能值直接对应效果值
所有技能值都直接对应效果值，不需要系数转换。技能值上限为10，类型为 `double`（保留2位小数）：

- **航速加成**：技能值总和直接等于增加的节数
  - 例如：技能值 5.60 = 增加 5.60 节，技能值 10.00 = 增加 10.00 节
  - 由于水手曲度高（a=10），单个水手技能值通常较低，需要多个水手累积
- **自动修理**：技能值总和直接等于每秒恢复的耐久数
  - 例如：技能值 5.00 = 每秒5点，技能值 10.00 = 每秒10点
  - 由于船工曲度低（a=2），更容易获得高技能值船工
- **开炮速度**：技能值总和直接等于每秒炮数
  - 例如：技能值 5.72 = 每秒 5.72 炮，技能值 10.00 = 每秒 10.00 炮
  - 炮手曲度中等（a=6），技能值分布介于水手和船工之间

### 触发机制说明
- **自动修理触发机制**：累积现实时间达到1秒时，计算修复量 = `autoRepairPerSecond × 累积时间`，然后一次性恢复
  - 例如：5.00点/秒，累积1秒后恢复5点；10.00点/秒，累积1秒后恢复10点
  - 注意：战斗中的自动修理使用游戏时间增量，详见 `2.9 combat_system.md`
- **开炮触发间隔**：`attackInterval = 1.0 / fireRatePerSecond`
  - 例如：5.72炮/秒 ≈ 0.175秒/炮，10.00炮/秒 = 0.1秒/炮
  - 战斗中使用游戏时间增量，详见 `2.9 combat_system.md`

## 2.4.9 与游戏系统的集成

### 在GameState中的使用
- `crewManager`: 船员管理器实例
- `maxCrewCount`: 最大船员数限制
- `crewCount`: 当前船员数量
- `currentSpeed`: 当前航速（节），已包含水手加成
- `sailingBonusPercent`: 航速加成百分比（用于兼容，实际加成以节为单位）
- `autoRepairPerSecond`: 自动修理效率（每秒）
- `fireRatePerSecond`: 开炮速度（每秒）
- `addCrewMember()`: 添加船员（带数量检查）
- `removeCrewMember()`: 移除船员

**注意**：水手加成在`currentSpeed`中直接使用节数，技能值总和直接等于增加的节数。最终航速 = 基础速度8节 + 水手增加的节数 + 天气修正。

### 航速计算
- **基础速度**：8节
- **水手加成**：根据水手技能计算，技能值直接对应节数（上限10，保留2位小数）
  - 计算公式：增加的节数 = 所有水手的sailorSkill总和
  - 示例：3个水手，总技能值 5.60 → 增加 5.60 节 → 最终速度 13.60 节
  - 由于水手曲度高（a=10），单个水手技能值通常较低，需要多个水手累积才能显著提升航速
  - **无上限限制**：航速加成没有上限，理论上可以通过招募大量水手无限提升航速
- **天气修正**：根据当前天气调整（+1节、0节、-2节）
- **最终速度**：基础速度 + 水手加成（节） + 天气修正
- **最小航速**：1节（确保船只始终可以移动，即使在恶劣天气下）

### 节（Knot）对航行时间的影响
- **节的定义**：在游戏中，"节"既是速度单位（节/小时），也作为距离单位使用
- **航行时间计算公式**：
  ```
  航行时间（游戏小时） = 航行距离（节） / 当前航速（节/小时）
  ```
- **示例计算**：
  - 距离192节，航速8节 → 航行时间 = 192 / 8 = 24小时
  - 距离192节，航速12节 → 航行时间 = 192 / 12 = 16小时
  - 距离192节，航速20节 → 航行时间 = 192 / 20 = 9.6小时
  - 距离192节，航速30节 → 航行时间 = 192 / 30 = 6.4小时
- **航速对时间的影响**：
  - 航速越高，航行时间越短
  - 航速从8节提升到20节，航行时间减少60%（从24小时减少到9.6小时）
  - 航速从8节提升到12节，航行时间减少33%（从24小时减少到16小时）
  - 航速提升没有上限，理论上可以通过招募大量水手达到极高的航速
- **实际应用**：
  - 玩家可以通过招募高技能水手来提高航速，缩短航行时间
  - 天气条件也会影响航速（小风+1节，风暴-2节）
  - 航速越高，航行时间越短，但需要更多水手和更高的成本
- **时间换算**：
  - 1现实秒 = 1游戏小时（基于昼夜系统的时间比例）
  - 如果航速是8节，1现实秒 = 航行8节的距离
  - 如果航速是20节，1现实秒 = 航行20节的距离
  - 航速越高，单位时间内航行的距离越长
  - **参考**：详见 `2.2 navigation_system.md`（航行进度计算）

### 自动修理集成
- 使用 dt 增量方式更新（每帧检查）
- 根据经过的时间自动恢复耐久度
- 使用`autoRepairPerSecond`计算恢复量
- **触发机制**：累积现实时间达到1秒时，计算修复量 = 修理效率 × 累积时间，然后一次性恢复
- **战斗中生效**：战斗时自动修理仍然有效，使用游戏时间增量更新
- **时间系统**：与昼夜系统的时间流逝同步（详见 `2.8 day_night_system.md`）

### 工资结算集成
- 每天00:00触发工资结算
- 由昼夜系统检测午夜跨越事件
- 扣除所有船员的工资总和
- **时间系统**：详见 `2.8 day_night_system.md`（时间事件）

## 2.4.10 港口酒馆招募系统

### 概述
港口酒馆是玩家招募新船员的主要场所。每次打开酒馆时，系统会随机生成3-5名可招募的船员，玩家可以查看他们的详细信息并支付招募费用来雇佣他们。

### 界面布局
酒馆对话框采用左右分栏布局：

```
┌────────────────────────────────────────┐
│ 港口酒馆 Tavern                        │
│────────────────────────────────────────│
│ ┌───────────────┐ ┌─────────────────┐ │
│ │ 船员列表      │ │ 船员详情        │ │
│ │ (可滚动)      │ │                 │ │
│ │               │ │ 头像 / 姓名     │ │
│ │ ▶ 船员A       │ │ 工资：30 / 天   │ │
│ │   船员B       │ │                 │ │
│ │   船员C       │ │ ⛵ 70            │ │
│ │               │ │ 🔧 20            │ │
│ │               │ │ 🔫 10            │ │
│ │               │ │                 │ │
│ │               │ │ [招募] [返回]   │ │
│ └───────────────┘ └─────────────────┘ │
└────────────────────────────────────────┘
```

### 左侧：船员列表
- **布局**：可滚动的列表，显示所有可招募船员
- **列表项结构**：
  ```
  ┌────────────────────────┐
  │ [头像]  姓名           │
  │ ⛵70  🔧20  🔫10   30G │
  └────────────────────────┘
  ```
- **交互**：点击列表项选中船员，高亮显示，右侧显示详情

### 右侧：船员详情
- **大头像**：显示船员头像（或占位符）
- **基本信息**：姓名、工资（金币/天）
- **技能详情**：
  - ⛵ 水手技能：数值
  - 🔧 船工技能：数值
  - 🔫 炮手技能：数值
- **角色描述**：风格化的文字描述
- **操作按钮**：
  - [招募船员]：打开确认对话框
  - [取消]：关闭酒馆对话框

### 招募确认对话框
点击"招募船员"后弹出确认对话框：
```
────────────
招募该船员？
工资：30 金币 / 天
招募费用：300 金币
当前船员数：3 / 5

[确认招募]   [再看看]
────────────
```

### 随机生成系统
每次打开酒馆时，系统会随机生成新的可招募船员：

- **生成数量**：3-5名船员（随机）
- **姓名生成**：从预定义的中文姓名池中随机选择，确保不与已有船员重复
- **技能值生成**：使用曲线公式生成，每个职业有不同的曲度参数
- **工资计算**：
  - 工资 = 总技能值 × 2.0 + 基础工资（1-10金币随机）
  - 总技能值 = 水手技能 + 船工技能 + 炮手技能
  - **定价策略**：基础工资较低（1-10金币随机），但技能值价值较高（×2.0），使得高技能船员工资显著提升

### 技能值生成公式
使用曲线公式计算最终技能值，确保不同职业有不同的数值分布特征：

**公式**：`y = C ⋅ (x / C)^a`

**参数说明**：
- `y`：最终技能值（输出，保留小数点后2位）
- `C`：上限值（cap）= 10
- `x`：随机数，范围 [0, C] = [0, 10]
- `a`：曲度参数，范围 [1, 10]
  - `a` 越大，`y` 输出大数字的可能性越低
  - `a = 1` 时，`y = x`（线性关系）
  - `a > 1` 时，曲线向下弯曲，大数值出现概率降低

**各职业曲度参数**：
- **水手**：`a = 10`（曲度最高，大数值出现概率最低）
- **船工**：`a = 2`（曲度较低，大数值出现概率较高）
- **炮手**：`a = 6`（曲度中等）

**公式特性**：
- 当 `x = C` 时，`y = C ⋅ (C/C)^a = C ⋅ 1^a = C`（达到上限）
- 当 `x = 0` 时，`y = C ⋅ (0/C)^a = 0`（最小值为0）
- 当 `a = 10`（水手）时，即使 `x` 较大，`y` 也会被显著压缩
- 当 `a = 2`（船工）时，`y` 更接近线性，大数值更容易出现

**示例计算**：
- 水手（a=10）：`x=8` → `y = 10 ⋅ (8/10)^10 = 10 ⋅ 0.8^10 ≈ 1.07`
- 船工（a=2）：`x=8` → `y = 10 ⋅ (8/10)^2 = 10 ⋅ 0.64 = 6.40`
- 炮手（a=6）：`x=8` → `y = 10 ⋅ (8/10)^6 = 10 ⋅ 0.262 ≈ 2.62`

**设计意图**：
- 水手技能值普遍较低，需要多个水手才能显著提升航速
- 船工技能值分布较均匀，更容易获得高技能船工
- 炮手技能值介于两者之间，平衡了获取难度和效果

### 招募费用
- **计算公式**：招募费用 = 工资 × 10
- **支付方式**：一次性支付，从玩家金币中扣除
- **示例**：工资30金币/天的船员，招募费用为300金币

### 招募条件检查
在招募前，系统会检查以下条件：
1. **金币是否足够**：玩家金币 ≥ 招募费用
2. **船员数是否已满**：当前船员数 < 最大船员数（默认5人）

如果条件不满足，显示相应的错误提示。

### 招募流程
1. 玩家打开港口酒馆 → 查看可招募船员列表
2. 点击列表项 → 查看船员详细信息
3. 点击"招募船员" → 弹出确认对话框
4. 确认招募 → 系统检查条件
5. 扣除招募费用 → 添加船员到船员列表
6. 从可招募列表中移除 → 显示成功提示
7. 前往船员管理界面 → 分配职业

### 数据模型
- **TavernDialog**：酒馆对话框组件
  - `gameState`：游戏状态（用于检查金币、船员数、添加船员）
  - `_availableCrew`：可招募船员列表
  - `_selectedCrew`：当前选中的船员
  - `_generateAvailableCrew()`：生成随机船员列表
  - `_recruitCrew()`：执行招募逻辑

### 与游戏系统的集成
- **入口**：通过"港口酒馆"按钮打开（位于岛屿左上方）
- **金币系统**：使用`GameState.spendGold()`扣除招募费用
- **船员系统**：使用`GameState.addCrewMember()`添加船员
- **限制检查**：使用`GameState.maxCrewCount`和`GameState.crewCount`检查船员数限制

## 2.4.11 与战斗系统的关系

### 攻击频率
- **使用值**：`GameState.fireRatePerSecond`（来自船员系统的炮手技能）
- **计算公式**：`fireRatePerSecond = 所有炮手的gunnerSkill总和`（技能值直接对应每秒炮数，上限10，保留2位小数）
- **战斗中使用**：战斗系统使用此值计算玩家攻击频率
- **触发机制**：累积时间达到触发间隔时发射，例如：技能值 5.72 = 每秒 5.72 炮 ≈ 0.175秒/炮
- **参考**：详见 `2.9 combat_system.md`（攻击机制）

### 修复频率
- **使用值**：`GameState.autoRepairPerSecond`（来自船员系统的船工技能）
- **计算公式**：`autoRepairPerSecond = 所有船工的shipwrightSkill总和`（技能值直接对应每秒恢复的耐久数，上限10，保留2位小数）
- **战斗中生效**：船工的自动修理在战斗中仍然有效
- **触发机制**：累积现实时间达到1秒时，计算修复量 = 修理效率 × 累积时间，然后一次性恢复。例如：技能值 10.00 = 每秒10点，累积1秒后恢复10点
- **参考**：详见 `2.9 combat_system.md`（修复机制）

### 统一游戏时钟
- **时间基准**：船员系统的自动修理和开炮速度使用统一的游戏时钟（`DayNightSystem`）
- **游戏时间增量**：战斗更新使用游戏时间增量（秒），计算公式：`dtGameSeconds = dtRealSeconds * timeScale * timeMultiplier / 60.0`
- **时间倍数影响**：当debug panel调整时间倍数时，船员系统的效果也会相应变化


