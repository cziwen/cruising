# 2.1 贸易系统（Trade System）

## 2.1.1 概述
玩家在各港口之间通过物品交换进行交易，基于物品基础价值计算交易偏向。动态经济模拟供需关系与区域特色。交易采用基于交换的机制，玩家和商人通过交换物品进行交易，而不是简单的金币买卖。系统已简化，移除了所有物理效果和复杂的装载机制。

## 2.1.2 核心要素

### 商品种类
- **基础商品**：食物、木材、香料、金属、奢侈品等
- **配置化数据**：所有商品定义均存储在 `assets/config/goods.json` 中
- 每种商品有唯一 ID、名称、类别、重量（kg）以及可选的图标路径（imagePath）
- 不同港口对同一种商品的基础价格（P₀）、价格敏感度（α）和正常库存基准（S₀）在 `assets/config/ports.json` 中独立配置
- 不同港口对同一种商品的基础价格不同，形成贸易机会

### 价格系统
- **动态价格公式**：基于港口库存的指数价格模型（用于显示和参考，实际交换基于基础价格）
  - **出售价（商人卖给玩家）**：`P_sell = P₀ · e^(-α((S - S₀)/100))`
    - `P₀`：港口定义的商品基础价格（理论价格锚点）
    - `S`：当前港口库存量
    - `S₀`：正常库存基准（商人的理想库存，即初始库存）
    - `α`：库存变化对价格的敏感度（0.01 ~ 0.99）
    - 当库存 > S₀：价格下降（供过于求）
    - 当库存 < S₀：价格上升（供不应求）
  - **收购价（商人收购玩家商品）**：`P_buy = P_sell · (1 - α)²`
    - 收购价永远为出售价的 `(1 - α)²` 倍
- **增量价格计算**：每个pending购买都会影响价格
  - 当玩家选择购买多个商品时，每个商品的价格基于前一个商品购买后的库存计算
  - 例如：购买50个商品时，第1个商品的价格基于当前库存S，第2个商品的价格基于库存S-1，第3个商品的价格基于库存S-2，以此类推
  - 总价 = 所有商品价格的累加，而不是 `单价 × 数量`
  - 这确保了每个pending购买都会立即影响后续商品的价格，形成更真实的供需关系
- **价格用途**：
  - 主要用于显示和参考，帮助玩家了解市场行情
  - **实际交换价值**：基于港口定义的该物品的基础价格（basePrice）计算，不受动态价格影响
- **动态经济**：玩家交换商品后，港口库存变化，价格相应变化（但交换价值仍基于各港口配置的基础价格）
- **区域特色**：不同港口对同一种商品的 `basePrice`、`alpha` 和 `s0` 不同，形成价格差异和贸易机会

### 交易界面（基于交换机制）
- **四栏布局**：
  - 左侧栏：商人库存（大格，可滚动显示所有商品，金币作为第一个物品）
  - 中间左侧：待换入物品栏（1个小格，显示pending的换入物品）
  - 中间右侧：待换出物品栏（1个小格，显示pending的换出物品）
  - 右侧栏：玩家库存（大格，可滚动显示所有商品，金币作为第一个物品）
- **交换机制**：交易基于物品交换，玩家用物品换物品，而不是用金币买卖
- **Pending机制**：点击物品后在GridView下方显示滑块面板选择数量，确认后移动到pending区域，不会立即执行交易
- **数量追加**：可以多次选择同一物品追加数量，滑块显示当前选择的新增数量
- **天平进度条**：显示交易偏向（左侧=偏向商人，中间=公平，右侧=偏向玩家）
- **交易确认**：点击"确认交易"按钮后，一次性执行所有pending的交换
- **交易接受规则**：商人只接受偏向自己或公平的交易（玩家换出价值 ≥ 换入价值）
- **金币作为物品**：金币作为普通物品显示在第一个物品格，价值永远是1:1

### 货物装载（基于重量系统）
- **自动装载**：购买完成后，商品自动添加到船上库存
- **容量检查**：购买前检查是否有足够载货重量空间（基于物品重量而非数量）
  - 每个商品都有重量属性（kg）
  - 载货空间以总重量计算：`已使用重量 = sum(物品数量 × 物品重量)`
  - 金币重量为0，不占用载货空间，可以无限携带
- **列表管理**：使用简单的列表式库存管理，无需手动摆放

## 2.1.3 系统流程（基于交换机制）
1. 玩家在港口界面 → 点击"交易"按钮打开交易界面
2. 查看商品和金币 → 金币作为第一个物品显示
3. 选择要换入的物品（从商人） → 点击商人库存的物品格，选择数量，移动到"待换入"区域
4. 选择要换出的物品（给商人） → 点击玩家库存的物品格，选择数量，移动到"待换出"区域
5. 查看天平进度条 → 实时显示交易偏向
6. 调整交换物品 → 确保交易偏向商人或公平（商人只接受这样的交易）
7. 确认交易 → 一次性执行所有pending的交换
8. 交易完成 → 物品直接交换，更新库存状态

## 2.1.4 界面设计

### 交易界面布局（基于交换机制）
```
┌─────────────────────────────────────────────────────────────┐
│  交易 - [港口名]                                    [关闭]  │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌─────────────┐  ┌──────────┐               │
│  │ 商人库存 │  │ 换入价值    │  │ 玩家库存 │               │
│  │ (大格)   │  │    ↔        │  │ (大格)   │               │
│  │ [金币]   │  │ 换出价值    │  │ [金币]   │  载重显示     │
│  │ [物品1]  │  ├─────────────┤  │ [物品1]  │               │
│  │ [物品2]  │  │[待换入] [待换出]│ [物品2]  │               │
│  │ [物品3]  │  │  (1格)  (1格)│  │ [物品3]  │               │
│  │ ...      │  └─────────────┘  │ ...      │               │
│  ├──────────┤                   ├──────────┤               │
│  │ 滑块面板 │                   │ 滑块面板 │               │
│  │(选中时显示)│                  │(选中时显示)│              │
│  └──────────┘                   └──────────┘               │
│                                                              │
│  ┌──────────────────────────────────────────────┐          │
│  │  天平进度条 [←偏向商人] [公平] [偏向玩家→]    │          │
│  └──────────────────────────────────────────────┘          │
│                                                              │
│                    [确认交易]                                │
└─────────────────────────────────────────────────────────────┘
```

### 滑块面板（选中物品时显示在GridView下方）
```
┌─────────────────────────────────────────┐
│  购买/出售: [物品名]          x [数量]   │
│  ════════════════○══════════════════    │  ← 滑块
│  总价: [价格]      [取消]  [确认]        │
└─────────────────────────────────────────┘
```

### 交换流程
1. **换入物品**：
   - 点击商人库存中的物品格（金币作为第一个物品） → 在GridView下方显示滑块面板
   - 使用滑块选择数量 → 显示当前选择数量的总价（增量价格）
   - 确认选择 → 物品移动到中间左侧的"待换入"区域（pending）
2. **换出物品**：
   - 点击玩家库存中的物品格（金币作为第一个物品） → 在GridView下方显示滑块面板
   - 使用滑块选择数量 → 显示当前选择数量的总价
   - 确认选择 → 物品移动到中间右侧的"待换出"区域（pending）
3. **追加数量**：
   - 再次点击已有pending的同一物品 → 滑块显示可追加的剩余数量
   - 确认后数量叠加到已有的pending物品上
4. **调整交换**：
   - 可以点击pending物品上的X按钮移除
   - 实时查看天平进度条，了解交易偏向
5. **确认交易**：
   - 点击"确认交易"按钮 → 一次性执行所有pending的交换
   - 玩家换出的物品 → 给商人
   - 玩家换入的物品 ← 从商人获得

### 交换机制
- **基于物品交换**：所有交易都是物品的直接交换，不再使用金币买卖
- **价值计算**：基于增量价格（totalPrice）计算价值，考虑库存变化
  - 玩家换出的价值 = 所有换出物品的增量总价（考虑库存变化）
  - 玩家换入的价值 = 所有换入物品的增量总价（考虑库存变化）
  - 金币价值 = 1:1（1金币 = 1价值）
- **交换执行**：
  - 玩家换出的物品 → 从玩家库存移除，添加到商人库存
  - 玩家换入的物品 ← 从商人库存移除，添加到玩家库存
- **载货空间检查**（基于重量）：
  - 考虑交换时先移除换出物品释放的重量
  - 计算换出物品的总重量：`totalGiveWeight = sum(换出物品数量 × 物品重量)`
  - 计算换入物品的总重量：`totalReceiveWeight = sum(换入物品数量 × 物品重量)`
  - 计算移除换出物品后的剩余空间：`剩余空间 = 总容量 - (当前使用重量 - 换出重量)`
  - 检查剩余空间是否足够容纳换入的物品：`剩余空间 >= 换入重量`
  - 金币重量为0，不参与重量计算
  - 例如：玩家载货容量100kg，当前使用80kg，用20kg物品换15kg物品 → 移除后剩余空间100kg，足够容纳换入的15kg物品
- **价值要求**：
  - 玩家换出的价值必须 ≥ 换入的价值
  - 不允许价值差额补齐（必须完全等值或偏向商人）

### 交易偏向系统
- **天平进度条**：实时显示当前pending交易的偏向
  - 左侧填充（红色）= 偏向商人（玩家换出价值 > 换入价值）
  - 中间（绿色）= 公平交易（玩家换出价值 = 换入价值）
  - 右侧填充（蓝色）= 偏向玩家（玩家换出价值 < 换入价值）
- **偏向计算**：`偏向 = (换入价值 - 换出价值) / 总价值`
- **交易接受规则**：商人只接受偏向自己或公平的交易
  - 如果交易偏向玩家（换出价值 < 换入价值），确认按钮会被禁用
  - 显示提示："交易不可接受（偏向玩家）"
- **价值要求**：玩家换出的价值必须 ≥ 换入的价值（不允许价值差额补齐）

### Pending机制
- **待换入区域**：显示1个待换入的物品（从商人那里获得）
- **待换出区域**：显示1个待换出的物品（给商人）
- **数量追加**：再次选择同一物品时，数量会叠加到已有的pending上
- **移除pending**：点击pending物品上的X按钮可以移除
- **批量执行**：点击"确认交易"后，所有pending物品一次性交换

## 2.1.5 数据模型

### 商品（Goods）
- `id`: 商品唯一标识
- `name`: 商品名称
- `category`: 商品类别
- `weight`: 商品重量（kg），用于计算载货空间占用
  - 金币重量为0.0 kg（不占用载货空间）
  - 其他商品根据类型设置不同重量（如食物1.0 kg，木材2.0 kg，金属5.0 kg等）
- `imagePath`: 商品图标资源路径（String?），用于在交易界面展示
- **配置来源**：`assets/config/goods.json`

### 港口商品价格（PortGoodsPrice）
- `portId`: 港口ID
- `goodsId`: 商品ID
- `buyPrice`: 当前买入价格（玩家购买商品的价格，即商人的出售价）
- `sellPrice`: 当前卖出价格（玩家出售商品的价格，即商人的收购价）
- `stock`: 港口当前库存（S），用于价格计算

### 港口（Port）
- `goodsStock`: 商品库存映射（`Map<String, int>`），记录每个商品在港口的当前库存量
  - 初始库存：游戏初始化时，每个港口的每个商品库存设置为该港口配置中该商品的 `s0` 值
  - 库存变化：玩家购买时减少，玩家出售时增加
  - 库存影响：库存变化直接影响价格计算
- `goodsConfig`: 商品配置映射（`Map<String, PortGoodsConfig>`），定义每个港口对每个商品的独立经济参数：
  - `basePrice`: 基础价格（P₀），该港口该商品的理论价格锚点
  - `alpha`: 价格敏感度（α）
  - `s0`: 正常库存基准（S₀），同时也是初始库存
- `merchantMoney`: 商人当前资金（int），用于补货计算
- `initialMerchantMoney`: 商人初始资金（int），每7天重置的基准值

### 船只库存（ShipInventory）
- `goodsId`: 商品ID
- `quantity`: 数量

### 待交易物品（PendingTradeItem）
- `goodsId`: 商品ID
- `quantity`: 数量
- `isBuying`: 是否为换入（true=换入，false=换出）
- `unitPrice`: 单价（保留用于向后兼容，实际不再使用）
- `totalPrice`: 增量计算的总价（考虑库存变化）

### 待交易集合（PendingTrade）
- `itemsToReceive`: 玩家要换入的物品列表（从商人那里获得）
- `itemsToGive`: 玩家要换出的物品列表（给商人）
- `tradeSystem`: 用于获取商品基础价格和重量
- `playerGivenValue`: 玩家换出的总价值（基于增量价格totalPrice，金币1:1）
- `playerReceivedValue`: 玩家换入的总价值（基于增量价格totalPrice，金币1:1）
- `calculateTradeFavor()`: 计算交易偏向（-1.0到1.0）
- `isTradeAcceptable()`: 判断商人是否接受交易
- `getTotalReceiveWeight()`: 计算待换入物品的总重量（kg）
- `getTotalGiveWeight()`: 计算待换出物品释放的总重量（kg）

## 2.1.6 价格更新机制

### 动态价格更新
- **更新频率**：每7天更新一次
- **触发时机**：由昼夜系统检测日期变化（每天00:00时检查）
- **更新方式**：将价格基准库存更新为当前实际库存，触发价格重新计算
- **时间系统**：详见 `2.8 day_night_system.md`（时间事件）

## 2.1.7 补货系统

### 补货机制
港口商人会根据当前库存和期望库存自动补货，使库存趋向于期望值（S₀）。

### 补货公式
补货增量（delta）的计算公式：
- **如果当前库存 > 期望库存（sT > s0）**：
  - `delta = -ceil(2 * ln(1+m) * (sT - s0))`
  - 库存过多，减少库存
- **如果当前库存 < 期望库存（sT < s0）**：
  - `delta = ceil(ln(1+m) * (s0 - sT))`
  - 库存不足，增加库存
- **如果当前库存 = 期望库存（sT = s0）**：
  - `delta = 0`
  - 库存正好，不变化

其中：
- `m`：商人当前资金（merchantMoney）
- `sT`：当前库存（currentStock）
- `s0`：期望库存（expectedStock，即配置的 S₀）

### 补货时机
- **执行频率**：每7天执行一次
- **执行时机**：与价格更新同时进行（在价格更新周期中）
- **执行顺序**：
  1. 首先重置商人资金（如果少于初始资金）
  2. 然后执行补货逻辑（使用重置后的资金）
  3. 最后更新价格基准库存

### 补货影响
- 补货会同时更新 `goodsStock`（实际库存）和 `priceBaseStock`（价格基准库存）
- 补货后，库存变化会影响商品价格的计算
- 库存不会为负数（通过 `clamp(0, infinity)` 确保）

## 2.1.8 商人资金系统

### 资金字段
- `merchantMoney`：商人当前资金，用于补货计算
- `initialMerchantMoney`：商人初始资金，每7天重置的基准值

### 资金变化（基于交换机制）
- **交换时**：如果交换的物品中包含金币，则相应更新商人资金
  - 玩家换出金币给商人：`merchantMoney += 金币数量`
  - 玩家换入金币从商人：`merchantMoney -= 金币数量`
- **注意**：在基于交换的机制中，金币作为普通物品参与交换，不再有单独的买卖逻辑

### 资金重置机制
- **重置频率**：每7天执行一次
- **重置时机**：与价格更新和补货同时进行
- **重置规则**：
  - 如果 `merchantMoney < initialMerchantMoney`：重置为 `initialMerchantMoney`
  - 如果 `merchantMoney >= initialMerchantMoney`：保持不变（不减少多余的资金）

### 资金初始化
- 游戏初始化时，如果港口未设置 `merchantMoney`，则将其设置为与 `initialMerchantMoney` 相同的值
- 每个港口可以配置不同的初始资金，形成区域经济差异