# 2.11 加载系统（Loading System）

## 2.11.1 概述
加载系统负责在场景切换（如从主菜单进入游戏，或从游戏返回主菜单）时提供平滑的过渡体验。通过显示一个短暂的加载画面，可以：
1.  遮挡场景初始化和销毁时的视觉跳变。
2.  为未来的资源预加载（如图片、音频、数据）预留占位。
3.  提供一致的用户体验反馈。

## 2.11.2 交互流程

### 主菜单 -> 游戏
1.  玩家在主菜单点击 "新游戏" 或 "继续游戏"。
2.  界面跳转至加载画面（LoadingScreen）。
3.  加载画面至少显示 1 秒（如果有额外的等待任务，则等待所有任务完成）。
4.  自动跳转至游戏主界面（GameScreen），通过淡入动画过渡。

### 游戏 -> 主菜单
1.  玩家在游戏内打开设置菜单，点击 "返回主菜单"。
2.  确认二次弹窗后，界面跳转至加载画面。
3.  加载画面至少显示 1 秒（如果有额外的等待任务，则等待所有任务完成）。
4.  自动跳转至主菜单界面（MainMenuScreen），通过淡入动画过渡。

## 2.11.3 UI 设计

加载画面保持极简风格，与游戏整体美术风格一致。

-   **背景**：复用封面背景 (`assets/images/painting/Cover_0.png`)，覆盖全屏。
-   **加载指示器**：屏幕中央显示白色圆形进度条 (`CircularProgressIndicator`)。
-   **提示文字**：指示器下方显示 "Loading..." 文本，白色粗体，带黑色阴影以保证可读性。

## 2.11.4 技术实现

### LoadingScreen 组件
位于 `lib/screens/loading_screen.dart`。

**参数**：
-   `nextScreen` (`Widget`): 加载完成后要跳转的目标页面。
-   `duration` (`Duration`): 最小加载持续时间，默认为 1 秒。
-   `waitFor` (`List<Future<dynamic>>?`): 可选的等待任务列表。
-   `onLoad` (`LoadCallback?`): 可选的加载回调，类型为 `Future<void> Function(BuildContext context)`。适用于需要 `context` 的加载操作（如 `precacheImage`）。

**逻辑**：
-   在 `didChangeDependencies` 中启动加载流程（确保 context 可用）。
-   同时等待 `duration` 计时器、`waitFor` 中的所有任务、以及 `onLoad` 回调。
-   当所有任务都完成后，使用 `Navigator.pushReplacement` 跳转至 `nextScreen`。
-   使用 `FadeTransition` (800ms) 实现页面间的平滑淡入淡出。

**使用示例**：

基础使用（仅等待1秒）：
```dart
LoadingScreen(nextScreen: GameScreen())
```

带 onLoad 回调（等待游戏资源预加载）：
```dart
LoadingScreen(
  nextScreen: const GameScreen(),
  onLoad: GameScreen.preload,
)
```

带 waitFor 任务列表：
```dart
LoadingScreen(
  nextScreen: GameScreen(),
  waitFor: [
    loadAssets(),
    initializeGameData(),
  ],
)
```

### GameScreen 预加载
`GameScreen` 提供静态方法 `preload(BuildContext context)` 用于预加载游戏资源。

**预加载的资源**：
-   `assets/images/painting/Cover_0.png`
-   `assets/images/buildings/village_stone_0.png`
-   `assets/images/buildings/business_port.png`
-   `assets/images/buildings/exotic_village.png`
-   `assets/images/pixel-sun-icon.png`

所有图片资源并行预加载，完成后 LoadingScreen 才会跳转到游戏界面。

### 导航管理
使用 `pushReplacement` 替代 `push`，确保加载画面在跳转后从导航堆栈中移除。这样用户在目标页面按“返回”键时，不会错误地回到加载画面，也不会回到已销毁的前一个场景。

