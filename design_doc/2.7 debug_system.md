# 2.7 调试系统（Debug System）

## 2.7.1 概述

调试系统为开发者和测试人员提供游戏内部状态查看和调试功能。通过调试面板（Debug Panel），可以快速调整游戏参数、跳过耗时操作、查看游戏状态，甚至在主菜单进行全局数据管理（如删除存档），提高开发和测试效率。

## 2.7.2 核心架构

### 调试面板位置
调试面板位于UI层（Layer 3），具体位置：
- **位置**：屏幕右上角（top: 60, right: 16）
- **层级**：位于所有游戏元素之上，但位于对话框之下
- **使用场景**：
  - **游戏内**：作为浮层显示，提供游戏状态修改功能。
  - **主菜单**：作为浮层显示，提供全局数据管理功能（如清空存档）。
- **样式**：橙色边框，半透明黑色背景，可折叠设计

### 组件结构
```
DebugPanel (StatefulWidget)
├── SizeTransition (展开/折叠动画)
│   └── Container (面板内容)
│       ├── 标题栏
│       ├── 调试选项列表 (游戏内功能)
│       │   ├── 跳过航行动画
│       │   ├── 时间流逝控制
│       │   ├── 时间倍数调整
│       │   ├── 触发战斗
│       │   └── 金币修改
│       ├── 全局功能列表 (通用功能)
│       │   └── 删除所有存档
│       └── 状态信息显示
└── FloatingActionButton (切换按钮)
```

## 2.7.3 功能模块

### 游戏内调试功能
以下功能仅在 `GameState` 存在时（即游戏进行中）可用。

#### 跳过航行动画开关
*   **功能描述**：启用后，航行过程将立即完成，跳过所有动画和等待时间。
*   **实现方式**：`Switch` 控制 `GameState.skipTravelAnimation`。

#### 时间流逝开关
*   **功能描述**：控制游戏内时间是否流逝。
*   **实现方式**：`Switch` 控制 `GameState.isTimePaused`。

#### 时间流逝倍数调整
*   **功能描述**：通过滑动条调整游戏内时间流逝的速度倍数（0.1x - 10.0x）。
*   **实现方式**：`Slider` 控制 `GameState.timeMultiplier`。

#### 立即触发战斗按钮
*   **功能描述**：在航行过程中立即触发战斗。
*   **实现方式**：按钮调用 `GameState.triggerCombatImmediately()`。
*   **条件**：仅在海上且非战斗状态下可用。

#### 添加金币按钮
*   **功能描述**：立即获得 1000 金币。
*   **实现方式**：按钮调用 `GameState.addGold(1000)`。

### 全局调试功能
以下功能在任何场景（包括主菜单）下均可用。

#### 删除所有存档
*   **功能描述**：一键清除所有存档数据（包括自动存档、手动存档和元数据），用于重置游戏环境或修复坏档。
*   **实现方式**：
    *   按钮调用 `SaveManager.deleteAllSaves()`。
    *   操作前会弹出确认对话框，防止误操作。
    *   **警告**：此操作不可撤销。

### 当前状态显示
*   **功能描述**：显示游戏当前的基本状态信息（如地点、战斗状态）。
*   **实现方式**：实时读取 `GameState` 属性显示。

## 2.7.4 UI设计

### 面板样式
- **背景**：半透明黑色（`Colors.black.withOpacity(0.8)`）
- **边框**：橙色，2px宽度（`Colors.orange`）
- **圆角**：8px（`BorderRadius.circular(8)`）
- **宽度**：200px
- **内边距**：12px

### 交互元素
- **危险操作**：如"删除所有存档"按钮使用红色背景，以示警告。
- **状态反馈**：操作成功（如添加金币、删除存档）后显示 `SnackBar` 提示。

## 2.7.5 状态管理

### GameState 集成
调试面板接收一个可空的 `GameState?` 参数：
- **如果不为空**：显示游戏内调试选项，并直接操作该实例。
- **如果为空**：仅显示全局调试选项。

### SaveManager 集成
全局功能直接调用 `SaveManager` 的静态方法，不依赖 `GameState` 实例。

## 2.7.6 技术实现

### 组件文件
- **位置**：`lib/game/debug_panel.dart`
- **类型**：`StatefulWidget`

### 核心逻辑
```dart
// 构造函数支持可选的 GameState
class DebugPanel extends StatefulWidget {
  final GameState? gameState;
  const DebugPanel({super.key, this.gameState});
  // ...
}

// 根据 gameState 是否为空构建 UI
if (widget.gameState != null) ...[
  // 构建游戏内调试选项
],
// 构建全局选项
ElevatedButton(
  onPressed: () async {
    // 确认并删除所有存档
    await SaveManager.deleteAllSaves();
  },
  // ...
),
```

## 2.7.7 使用场景

### 开发阶段
- **快速测试**：使用跳过航行动画快速验证功能。
- **时间测试**：使用时间倍数快速测试长时间游戏逻辑。
- **坏档修复**：在主菜单使用"删除所有存档"清除损坏的数据，恢复初始状态。

### 测试阶段
- **回归测试**：快速验证修复后的功能。
- **全新开始**：确保每次测试都在干净的环境下进行（删除存档）。

## 2.7.8 注意事项

### 安全性
- **删除存档**：是一个破坏性操作，必须包含二次确认。
- **生产环境**：发布正式版时应考虑隐藏或通过特定手势/作弊码激活此面板。

---

**最后更新**：2024年（添加主菜单支持与全局存档管理）
