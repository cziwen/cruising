# 2.5 UI系统（UI System）

## 2.5.1 概述
UI系统负责游戏的所有界面元素和交互。UI层包含状态栏、按钮、对话框等所有交互元素，支持响应式布局和动画效果。

**注意**：6层渲染系统的详细说明请参考 `2.6 scene_system.md`。本文档专注于UI层的组件和交互。

## 2.5.2 核心架构

### UI层位置
UI层位于渲染系统的最顶层（Layer 3），覆盖所有其他层：
- 位于场景层（背景、岛屿、船只）之上
- 处理所有用户交互
- 包含所有界面元素和按钮

## 2.5.3 界面组件

### 状态栏（StatusBar）
位于屏幕底部，双行显示游戏核心信息。

#### 第一行：核心资源
- **左侧**：金币显示（💰 图标 + 数值，黄色）
- **中间**：当前位置（📍 图标 + 港口名称或"海上"，白色）
- **右中**：载货量（📦 图标 + 已用/总量，蓝色）
- **右侧**：船员数量（👥 图标 + 当前/最大(士气值)，绿色）

#### 第二行：运营与航行状态
- **左侧**：船只耐久（🔧 图标 + 当前/最大，橙色）
- **左中**：修复速度（🔨 图标 + 数值/秒，橙色）
- **右中**：炮火攻击力（🎯 图标 + 数值 炮/秒，红色）
- **右侧**：航速（⛵ 图标 + 节数，青色）

#### 样式特点
- 半透明黑色背景（alpha: 0.2）
- 圆角顶部边框
- 阴影效果
- 自适应字体和图标大小（根据屏幕宽度）

### 时间显示（TimeDisplay）
位于屏幕左上角，显示游戏内时间。

- **位置**：左上角（top: 8, left: 8）
- **内容**：时钟图标 + 时间文本（格式：HH:00）
- **样式**：半透明黑色背景，白色边框，文字阴影
- **更新**：通过AnimatedBuilder实时更新
- **数据源**：`DayNightSystem.currentTime`
- **参考**：详见 `2.8 day_night_system.md`（时间系统）

### 航行进度条
位于屏幕顶部，仅在海上航行时显示。

- **位置**：顶部（left: 100, right: 16，避免与时间显示冲突）
- **内容**：
  - 目的地名称和剩余时间（X天Y小时格式）
  - 线性进度条显示航行进度
- **样式**：半透明黑色背景，蓝色进度条
- **显示条件**：`isAtSea && totalTravelDistance > 0`
- **计算方式**：基于距离（节）和当前航速计算进度和剩余时间

### 岛屿周围按钮
仅在完全入港后显示（不在过渡中且不在海上）。

#### 市场按钮
- **位置**：岛屿左侧（islandCenterX - 250, islandCenterY - 50）
- **颜色**：蓝色
- **功能**：打开交易界面

#### 人才市场按钮
- **位置**：岛屿左上方（islandCenterX - 220, islandCenterY - 150）
- **颜色**：紫色
- **功能**：打开人才市场界面（招募船员）

#### 设置按钮
- **位置**：岛屿右上方（islandCenterX + 220, islandCenterY - 150）
- **颜色**：蓝灰色
- **功能**：打开设置对话框（包含音乐、音效、全屏及分辨率设置）

#### 船厂按钮
- **位置**：岛屿右侧（islandCenterX + 150, islandCenterY - 50）
- **颜色**：橙色
- **功能**：打开船厂界面（船只升级和维修）

#### 船员管理按钮
- **位置**：岛屿右下方（islandCenterX + 120, islandCenterY + 80）
- **颜色**：青色
- **功能**：打开船员管理对话框

#### 按钮样式
- 圆角矩形（borderRadius: 8）
- 阴影效果（elevation: 4）
- 白色粗体文字
- 内边距：horizontal: 20, vertical: 12

### 选择目的地按钮
位于屏幕右下角，浮动按钮样式。

- **位置**：右下角（bottom: 80, right: 16）
- **样式**：绿色浮动按钮（FloatingActionButton.extended）
- **图标**：地图图标
- **文字**："选择目的地"
- **显示条件**：不在过渡中且不在海上

### 调试面板（DebugPanel）
位于屏幕右上角，可折叠面板。

- **位置**：右上角（top: 60, right: 16）
- **功能**：
  - 跳过航行动画开关
  - 显示当前状态信息
- **样式**：橙色边框，半透明黑色背景
- **交互**：点击小按钮展开/折叠

## 2.5.4 对话框系统

### 交易对话框（TradeDialog）
显示当前港口的商品交易界面。

#### 布局结构
```
┌─────────────────────────────────┐
│  交易 - [港口名称]        [关闭] │
├─────────────────────────────────┤
│  金币: [数量]  载货: [已用]/[总量]│
├─────────────────────────────────┤
│  商品列表:                       │
│  ┌───────────────────────────┐ │
│  │ 商品名                     │ │
│  │ 买入: X | 卖出: Y | 库存: Z│ │
│  │              [买] [卖]     │ │
│  └───────────────────────────┘ │
│  ...                            │
└─────────────────────────────────┘
```

#### 功能
- 显示所有商品及其价格
- 显示船上库存数量
- 购买/出售商品
- 实时更新金币和载货量

#### 交互流程
1. 点击"买"按钮 → 弹出数量输入对话框
2. 输入购买数量 → 显示总价和容量检查
3. 确认购买 → 自动添加到库存，扣除金币
4. 点击"卖"按钮 → 弹出出售数量对话框
5. 输入出售数量 → 显示预期收益
6. 确认出售 → 从库存移除，增加金币

### 港口选择对话框（PortSelectDialog）
显示可访问的港口列表，用于选择航行目的地。

#### 布局结构
```
┌─────────────────────────────────┐
│  选择目的地              [关闭] │
├─────────────────────────────────┤
│  港口列表:                       │
│  ┌───────────────────────────┐ │
│  │ 📍 港口名称               │ │
│  │    港口描述               │ │
│  │              [出发]/当前港口│ │
│  └───────────────────────────┘ │
│  ...                            │
└─────────────────────────────────┘
```

#### 功能
- 显示所有已解锁的港口
- 高亮显示当前港口
- 点击"出发"按钮开始航行
- 显示港口描述信息

### 船员管理对话框（CrewManagementDialog）
显示和管理船上的船员。

#### 布局结构
```
┌─────────────────────────────────┐
│  船员管理                [关闭] │
├─────────────────────────────────┤
│  统计区域:                        │
│  ⛵ 水手: X  🔧 船工: Y  🔫 炮手: Z│
│  航速加成: X%                     │
│  自动修理: X / 秒                 │
│  开炮速度: X 炮/秒               │
├─────────────────────────────────┤
│  船员列表:                        │
│  ┌───────────────────────────┐ │
│  │ [头像] 姓名      工资：X/天│ │
│  │ ⛵ 70  🔧 20  🔫 10      │ │
│  │ 分配为：[职业选择器]        │ │
│  └───────────────────────────┘ │
│  ...                            │
└─────────────────────────────────┘
```

#### 功能
- 显示各职业的船员数量
- 显示综合加成效果
- 查看每个船员的详细信息
- 分配/更改船员职业
- 实时更新加成值

### 人才市场对话框
用于招募新船员（开发中）。

- 显示可招募的船员列表
- 显示船员技能值和工资
- 确认招募后添加到船员列表
- 临时功能：添加测试船员

### 船厂对话框
用于船只升级和维修（开发中）。

- 显示船只当前属性
- 显示可用的升级选项
- 显示升级成本和效果
- 确认升级后更新船只属性

### 设置对话框（SettingsDialog）
用于游戏设置调整。

- **音乐/音效**：开关控制
- **显示设置**（仅桌面端）：
  - 全屏模式切换
  - 分辨率选择（非全屏模式下）
- **游戏控制**：
  - **保存游戏**：保存当前进度（开发中）
  - **返回主菜单**：带有二次确认的退出功能
- **功能**：与主菜单设置保持一致，支持实时生效

## 2.5.5 动画效果

### 岛屿切换动画
- **类型**：滑入滑出动画（SlideTransition）
- **时长**：1500ms
- **效果**：
  - 当前岛屿向左滑出屏幕（Offset(-1.0, 0.0)）
  - 新岛屿从右侧滑入屏幕（Offset(1.0, 0.0) → Offset.zero）
- **曲线**：Curves.easeInOut

### 船只浮动动画
- **类型**：上下浮动（Transform.translate）
- **范围**：-5px 到 +5px
- **时长**：2秒循环
- **曲线**：Curves.easeInOut
- **位置**：屏幕中央，向下偏移100像素

### 调试面板展开/折叠
- **类型**：SizeTransition
- **时长**：300ms
- **曲线**：Curves.easeInOut

## 2.5.6 响应式设计

### 自适应字体大小
状态栏使用自适应字体大小：
```dart
final fontSize = (screenWidth / 20).clamp(10.0, 14.0);
final iconSize = (screenWidth / 22).clamp(16.0, 20.0);
```

### SafeArea支持
- 状态栏和时间显示使用SafeArea包裹
- 确保在刘海屏等特殊屏幕上正确显示

## 2.5.7 按钮显示逻辑

### 显示条件
岛屿周围按钮仅在以下条件同时满足时显示：
- `!isTransitioning`：不在切换动画中
- `!isAtSea`：不在海上
- `currentPort != null`：当前有港口

### 延迟显示
入港后额外等待200ms确保动画完全结束，避免按钮在动画过程中显示。

## 2.5.8 数据模型

### UI层组件
- `UILayer`: UI层主组件
- `StatusBar`: 状态栏组件
- `TimeDisplay`: 时间显示组件
- `DebugPanel`: 调试面板组件

### 对话框组件
- `TradeDialog`: 交易对话框
- `PortSelectDialog`: 港口选择对话框
- `CrewManagementDialog`: 船员管理对话框

**注意**：背景层、天体层、近背景层、船层属于场景系统，详见 `2.6 scene_system.md`

## 2.5.9 交互流程

### 交易流程
1. 玩家在港口 → 点击"市场"按钮
2. 打开交易对话框 → 查看商品价格
3. 选择商品 → 点击"买"或"卖"按钮
4. 输入数量 → 确认交易
5. 更新状态 → 关闭对话框

### 航行流程
1. 玩家在港口 → 点击"选择目的地"按钮
2. 打开港口选择对话框 → 查看可访问港口
3. 选择目标港口 → 点击"出发"按钮
4. 关闭对话框 → 开始航行动画
5. 显示航行进度条 → 到达目的地

### 船员管理流程
1. 玩家在港口 → 点击"船员管理"按钮
2. 打开船员管理对话框 → 查看当前船员
3. 调整职业分配 → 通过下拉菜单选择
4. 查看效果变化 → 加成值实时更新
5. 确认更改 → 关闭对话框

## 2.5.10 样式规范

### 颜色方案
- **蓝色**：市场、载货量、进度条
- **绿色**：选择目的地、船员数量
- **橙色**：船厂、船只耐久、调试面板
- **紫色**：人才市场
- **青色**：船员管理、航速
- **蓝灰色**：设置
- **黄色**：金币
- **红色**：炮手相关
- **白色**：位置显示、时间显示

### 字体规范
- **标题**：20-22px，粗体
- **正文**：14-16px，常规
- **小字**：10-12px，常规
- **按钮文字**：16px，粗体

### 间距规范
- **内边距**：12-16px
- **外边距**：8-16px
- **按钮间距**：8px
- **列表项间距**：4px

### 圆角规范
- **对话框**：16px
- **按钮**：8px
- **卡片**：8px
- **状态栏**：12px（顶部）

## 2.5.11 性能优化

### 图片加载
- 使用`gaplessPlayback: true`避免切换时的闪烁
- 使用`filterQuality: FilterQuality.medium`优化性能
- 提供错误处理，加载失败时显示备用UI

### 动画优化
- 使用`AnimatedBuilder`和`AnimatedSwitcher`优化动画性能
- 缓存计算结果，避免重复计算
- 使用`SingleTickerProviderStateMixin`管理动画控制器

### 列表优化
- 使用`ListView.builder`实现虚拟滚动
- 限制对话框最大高度，避免溢出
- 使用`Flexible`和`Expanded`实现响应式布局


