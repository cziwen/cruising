# 2.12 存档系统 (Save System)

## 2.12.1 概述
存档系统负责游戏数据的持久化存储，支持玩家在不同游戏会话间保留进度。系统提供自动存档和手动存档功能，确保游戏进度不会因退出或意外中断而丢失。

## 2.12.2 核心功能
1.  **多槽位支持**：提供 4 个独立的存档槽位。
    *   **Slot 0 (Auto Save)**：自动存档专用，不可手动覆盖。
    *   **Slot 1-3 (Manual Save)**：玩家自由保存的手动存档位。
2.  **自动存档**：当玩家抵达新港口（岛屿）时，系统自动保存当前状态到 Slot 0。
3.  **元数据管理**：每个存档记录关键摘要信息（时间、地点、金币、天数），便于玩家在读取前预览。
4.  **跨平台支持**：使用 `path_provider` 库，确保在 Windows, Android, iOS 等平台上均能正确读写文件。
5.  **调试支持**：提供一键删除所有存档的功能，便于开发和测试重置环境。

## 2.12.3 数据结构

### 存档槽位元数据 (`SaveSlot`)
用于在存档列表中展示简要信息，无需读取完整的游戏数据文件。
```dart
class SaveSlot {
  final int id;           // 槽位ID (0-3)
  final String timestamp; // 存档时间 (ISO 8601)
  final String portName;  // 当前所在港口名称
  final int gold;         // 当前持有金币
  final String captainName;// 船长名称
  final int day;          // 游戏内天数
}
```

### 游戏完整状态
完整的 `GameState` 序列化为 JSON 格式存储，包含以下关键数据：
-   **基础信息**：金币 (`gold`)、时间 (`dayNightSystem`)、天气 (`weather`)。
-   **位置信息**：当前港口 (`currentPortId`)、目标港口 (`destinationPortId`)、航行进度 (`travelProgress`)。
-   **船只信息**：属性 (`ship`)、库存 (`inventory`)、船员列表 (`crewMembers`)。
-   **世界动态状态**：所有港口的动态数据 (`ports`)，包括当前实际商品库存、商人资金、价格基准库存。
-   **静态配置解耦**：港口的基础配置（名称、背景图、基础经济参数 alpha/s0）仍由 `assets/config/*.json` 提供，存档仅存储随游戏进程变化的动态数值。

## 2.12.4 交互流程

### 保存游戏
1.  **触发方式**：
    *   **自动**：`GameState.switchToPort` 完成后触发。
    *   **手动**：在游戏内设置菜单点击 "保存游戏"，进入存档界面选择 Slot 1-3。
2.  **流程**：
    *   将 `GameState` 序列化为 Map。
    *   写入 `save_slot_{id}.json` 文件。
    *   更新 `save_meta.json` 中的元数据。
    *   界面提示 "保存成功"。

### 读取游戏
1.  **触发方式**：
    *   **主菜单 "继续游戏"**：自动寻找时间最近的一个存档并加载。
    *   **主菜单 "读取存档"**：进入存档界面，手动选择任意槽位。
    *   **游戏内 "读取游戏"**：进入存档界面，手动选择任意槽位。
2.  **流程**：
    *   读取选定槽位的 `save_slot_{id}.json` 文件。
    *   反序列化数据。
    *   初始化 `GameState` 并应用读取的数据。
    *   跳转至 `GameScreen`。

### 删除存档
1.  **单个删除**：
    *   在存档管理界面，点击垃圾桶图标可删除指定的手动存档。
    *   同时删除对应的数据文件和元数据条目。
2.  **全部删除（调试）**：
    *   通过 Debug Panel 的 "删除所有存档" 按钮触发。
    *   调用 `SaveManager.deleteAllSaves()`。
    *   物理删除所有 `save_slot_*.json` 文件和 `save_meta.json`。
    *   此功能主要用于开发调试。

## 2.12.5 文件结构
存档文件存储在应用文档目录 (`ApplicationDocumentsDirectory`) 下：
*   `save_meta.json`: 存储所有槽位的元数据列表。
*   `save_slot_0.json`: 自动存档数据。
*   `save_slot_1.json`: 手动存档 1 数据。
*   `save_slot_2.json`: 手动存档 2 数据。
*   `save_slot_3.json`: 手动存档 3 数据。

## 2.12.6 依赖库
*   `path_provider`: 获取跨平台的文件存储路径。
*   `intl`: 用于格式化显示存档时间。
