# 2.2 导航系统（Navigation System）

## 2.2.1 概述
导航系统负责管理港口之间的航行，包括距离计算、航速计算、航行进度显示等。系统基于距离（节）和当前航速来计算航行时间和进度。

## 2.2.2 核心要素

### 距离定义
- **单位**：节（knots）
- **换算关系**：8节 = 每小时（真实时间1秒）的形式距离
- **港口距离**：每个港口包含 `distances` 映射（目标港口ID → 距离（节））
- **示例**：192节 = 24小时（基础航速8节时）

### 航速计算
- **基础速度**：8节
- **水手加成**：根据水手技能计算，转换为节数
- **天气修正**：根据当前天气调整（+1节、0节、-2节）
- **最终速度**：基础速度 + 水手加成 + 天气修正（限制在1-15节）

### 航行进度计算
- **总距离（节）** = 港口间距离（节）
- **已航行距离（节）** = 当前航速（节） × 累积的游戏小时数
- **进度** = 已航行距离（节） / 总距离（节）
- **剩余距离（节）** = 总距离（节） - 已航行距离（节）
- **剩余时间（游戏小时）** = 剩余距离（节） / 当前航速（节）

### 时间换算
- 1现实秒 = 1游戏小时（基于昼夜系统的时间比例）
- 如果航速是8节，1现实秒 = 8节的距离
- 如果航速是10节，1现实秒 = 10节的距离
- **时间系统**：详见 `2.8 day_night_system.md`（时间比例）

## 2.2.3 航行流程

### 选择目的地
1. 玩家在港口界面 → 点击"选择目的地"按钮
2. 打开港口选择对话框 → 显示可访问的港口列表
3. 显示每个港口的信息：
   - 港口名称
   - 港口描述
   - 当前港口标记
4. 玩家选择目标港口 → 点击"出发"按钮

### 开始航行
1. 离开当前港口，进入海上状态
2. 获取航行距离（节）
3. 初始化进度计算（总距离、已航行距离）
4. 开始实时更新进度

### 航行过程
1. 顶部显示航行进度条
2. 显示目标港口名称
3. 显示剩余时间（格式：X天Y小时）
4. 进度条实时更新（每帧更新，通常 60fps）
5. 使用 dt 增量方式更新，确保平滑流畅
6. **视觉反馈**：航行位移 (`totalSailingOffset`) 被实时累加到 `GameState` 中，用于驱动所有背景层和波浪层的水平滚动动画，模拟船只破浪前行的视觉效果。**滚动速度与当前航速成正比**，基础航速（8节）对应基础滚动速度（50像素/秒）。
7. **动态调整**：如果航速在航行中变化（例如天气变化），剩余时间会重新计算，且背景滚动速度也会同步调整。

### 到达港口
1. 进度达到100%
2. 触发场景切换动画
3. 切换到目标港口
4. 更新游戏状态

## 2.2.4 技术实现

### 进度更新机制
- 使用 `Ticker` 每帧更新进度
- 计算实际时间增量 dt（秒）
- 转换为游戏内时间增量（1现实秒 = 1游戏小时）
- 累积游戏内时间
- 计算已航行距离 = 当前航速 × 累积游戏小时数
- 计算进度 = 已航行距离 / 总距离

### 状态管理
- `totalTravelDistance`：总航行距离（节）
- `accumulatedDistance`：已航行距离（节）
- `travelProgress`：航行进度（0.0-1.0）
- `remainingTravelHours`：剩余航行时间（游戏小时）

### 动态航速支持
- 航速可能在航行中变化（天气变化、船员变化）
- 每次更新进度时重新获取当前航速
- 剩余时间会根据新的航速重新计算

## 2.2.5 数据模型

### 港口（Port）
- `id`: 港口唯一标识
- `name`: 港口名称
- `distances`: 距离映射（目标港口ID → 距离（节））
- `getDistanceTo()`: 获取到目标港口的距离（节）

### 航行状态
- `currentPort`: 当前港口（null表示在海上）
- `destinationPort`: 目标港口（航行时使用）
- `isAtSea`: 是否在海上
- `isTransitioning`: 是否正在切换场景
- `totalTravelDistance`: 总航行距离（节）
- `accumulatedDistance`: 已航行距离（节）
- `travelProgress`: 航行进度（0.0-1.0）

## 2.2.6 与其他系统的关系

### 场景系统
- 导航系统负责计算航行进度和时间
- 场景系统负责背景切换和动画效果
- 两个系统协同工作：导航系统计算完成后，触发场景系统进行切换
- **参考**：`2.6 scene_system.md`

### 昼夜系统
- 航行时时间继续流逝（由昼夜系统管理）
- 时间倍数可能影响航行进度（如果基于游戏时间）
- **参考**：`2.8 day_night_system.md`

### 船员系统
- 航速计算依赖水手加成
- 水手技能影响最终航速
- **参考**：`2.4 crew_system.md`
