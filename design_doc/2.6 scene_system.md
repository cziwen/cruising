# 2.6 场景系统（Scene System）

## 2.6.1 概述
场景系统负责管理游戏的视觉呈现，采用7层渲染架构，通过切换背景层来表现不同的港口场景。船永远保持在屏幕中央，通过背景切换来表现"航行"到不同港口的效果。所有层的动画效果（滚动、晃动）由 `GameState` 集中管理，确保视觉上的完美同步。

**注意**：场景系统只负责视觉呈现和动画效果，不包含游戏逻辑。战斗相关的逻辑和状态管理请参考 `2.9 combat_system.md`。

## 2.6.2 核心要素

### 单场景设计
- **固定场景**：游戏始终在同一场景中进行
- **船居中**：船只永远固定在屏幕中央，不移动
- **背景切换**：通过切换近背景层来表现不同的港口场景
- **动态海浪效果**：所有背景层（包括港口、云朵、波浪）都会以一定频率左右晃动，模拟海面起伏的氛围。
- **无物理效果**：移除所有物理模拟（重力、浮力、风力等）

### 7层渲染系统

#### 背景层（Layer 0）
- **内容**：远距离背景元素（多层视差）
- **特点**：
  - **动态滚动**：包含左右晃动和水平滚动效果，遵循视差规则（远处移动慢，近处移动快）。
  - **常驻漂移**：云层（cloud1-3）具有基础漂移速度，即使船只静止时也会缓慢移动，增加场景生动感。
  - **层级集成**：**天体层（Layer 0.5）**现已集成在此层内部，位于海底背景与波浪/云朵之间。
- **元素**：
  - `oceanbg_0_underwater.png` (最底层)
  - **天体层** (太阳/月亮)
  - `oceanbg_0_wave3.png`
  - `oceanbg_0_wave2.png`
  - `oceanbg_0_wave1.png`
  - `oceanbg_0_cloud3.png`
  - `oceanbg_0_cloud2.png`
  - `oceanbg_0_cloud1.png` (最顶层)
- **切换**：一般不切换，作为全球通用的海洋背景
- **实现**：`BackgroundLayer`，使用 `GameState.totalSailingOffset` 处理航行滚动，使用 `GameState.swayTime` 处理基础漂移（仅云层）和全局晃动。通过三张图片循环拼接实现无缝横向滚动。内部集成 `CelestialLayer`。

#### 近背景层（Layer 1）
- **内容**：近距离背景元素，表现当前港口
- **特点**：根据当前港口动态切换。岛屿和建筑物固定，不随海浪晃动以保持稳定性。
- **主岛进化**：对于玩家主岛（ID: `home_island`），背景图片不再固定，而是根据岛屿等级（0-7级）动态加载 `village_{level}.png`。
- **元素**：港口建筑、码头、岛屿、海岸线、其他船只等
- **切换**：点击选择新港口后，使用滑入滑出动画切换（1500ms）
- **实现**：`NearBackgroundLayer`。

#### 船层（Layer 2）
- **内容**：玩家的船只和敌方船只（战斗时）
- **特点**：正常状态下玩家船只永远居中，战斗时玩家船只左移，敌方船只从右侧滑入。不随海浪晃动以保持 UI 稳定性。
- **位置**：屏幕中央固定位置（正常状态），战斗时根据战斗状态调整位置
- **动画**：
  - 正常状态：固定在中央
  - 战斗状态：玩家船只左移，敌方船只滑入，沉船动画等（详见 `2.9 combat_system.md`）
- **实现**：`ShipLayer`

#### 前景波浪层（Layer 2.3）
- **内容**：位于船之后的前景波浪
- **特点**：左右晃动幅度最大（视差最前层），模拟波浪拍打感。
- **实现**：`ForegroundWaveLayer`，使用 `GameState.totalSailingOffset` 处理滚动，使用 `GameState.swayTime` 处理晃动。

#### 屏幕效果层（Layer 2.5）
- **内容**：全屏视觉效果
- **特点**：位于船层之上，UI层之下，用于特殊视觉效果
- **元素**：渐变黑屏（战斗失败时）、其他全屏效果
- **动画**：使用`AnimatedContainer`实现平滑过渡（2秒）
- **交互**：始终忽略点击事件（`IgnorePointer`），仅作为视觉层
- **实现**：`ScreenEffectLayer`
- **状态**：通过`GameState.isFadeOut`控制

#### UI层（Layer 3）
- **内容**：所有界面元素
- **特点**：最顶层，覆盖其他所有层
- **元素**：按钮、菜单、信息显示、对话框、交易界面等
- **交互**：处理所有用户输入和界面交互
- **实现**：`UILayer`

#### 时间显示（Layer 3.5）
- **内容**：左上角时间显示
- **特点**：独立于其他UI元素
- **实现**：`TimeDisplay`

## 2.6.3 集中动画管理
为了确保所有层的滚动和晃动效果完美同步，系统采用了集中状态管理模式：

1. **状态维护**：`GameState` 在每帧更新时（`updateDayNightSystemWithDeltaTime`）维护以下状态：
   - `swayTime`：持续增加的计时器，用于驱动所有层的 `sin` 波晃动。
   - `totalSailingOffset`：仅在航行时累加的位移值，用于驱动所有滚动层的水平位移。

2. **视差规则**：各层在接收到集中状态后，根据自身的系数应用位移：
   - **滚动偏移** = `-(totalSailingOffset * speedMultiplier + swayTime * baseDriftSpeed + initialOffset)`
   - **晃动幅度** = `baseAmplitude * speedMultiplier`
   - 这样确保了近处的物体（如前景波浪）比远处的物体（如云、远山）移动和晃动得更明显，且云层在静止时也能保持自然的漂移感。
   - **常驻漂移**：仅云层设置了 `baseDriftSpeed`，海底和海浪层该值为 0。
   - **例外**：近背景层（岛屿和建筑物）由于其物理性质，不应用晃动效果，但其在航行切换时的移动速度同样与 `currentSpeed` 挂钩。

## 2.6.3 港口切换流程

### 港口选择
1. 玩家在港口界面 → 点击"选择目的地"按钮
2. 弹出港口选择界面 → 显示可访问的港口列表
3. 显示每个港口的信息：
   - 港口名称
   - 港口描述
   - 当前港口标记
4. 玩家选择目标港口 → 点击"出发"按钮

### 场景切换动画
1. **离开当前港口**：
   - 触发切换 → 开始滑出动画
   - 岛屿图像向左滑出屏幕
   - 显示"航行中..."提示（可选）
   
2. **航行过程**：
   - 显示海洋背景
   - 显示航行进度条
   - 隐藏所有岛屿交互按钮
   
3. **到达新港口**：
   - 新岛屿图像从右侧滑入屏幕
   - 动画时长：1500ms
   - 等待动画完成
   - 额外等待200ms确保完全入港
   
4. **更新游戏状态**：
   - 切换到新港口
   - 更新商品价格等
   - 显示所有交互按钮

## 2.6.4 系统流程
1. 玩家在港口A → 查看商品，进行交易
2. 点击"选择目的地" → 打开港口选择界面
3. 选择港口B → 点击"出发"
4. 触发导航系统 → 开始计算航行进度
5. 背景切换动画 → 近背景层从港口A切换到港口B
6. 到达港口B → 显示新港口场景，船仍在中央
7. 自动打开交易界面（可选）→ 玩家可以开始新的交易

## 2.6.5 技术实现

### 场景管理
- 使用Flutter的`Stack`组件实现多层叠加
- 每层使用独立的Widget管理
- 使用状态管理控制当前显示的港口和背景

### 背景切换动画
- 使用`SlideTransition`实现滑入滑出效果
- 切换时间：1500ms
- 使用`Curves.easeInOut`缓动曲线
- 当前岛屿向左滑出（Offset(-1.0, 0.0)）
- 新岛屿从右侧滑入（Offset(1.0, 0.0) → Offset.zero）

### 港口数据
- 每个港口有对应的背景图片资源，定义在 `assets/config/ports.json` 中
- 港口配置包含：名称、背景资源路径、描述、目的地距离映射以及商品经济配置（alpha, s0）
- 距离定义在配置中管理，由 `GameConfigLoader` 加载

## 2.6.6 与战斗系统的关系

场景系统为战斗系统提供视觉呈现支持：

### 船只位置管理
- **正常状态**：玩家船只居中显示
- **战斗状态**：根据战斗系统的状态调整船只位置
  - 玩家船只：向左移动150像素（`playerShipXOffset`）
  - 敌方船只：从右侧滑入（`enemyShipXOffset`）

### 战斗动画支持
场景系统的船层（Layer 2）负责渲染战斗相关的动画：
- **敌方船只滑入**：使用`SlideTransition`实现（1500ms）
- **沉船动画**：使用`AnimationController`控制y坐标增加（2秒）
- **位置同步**：通过`GameState`的状态同步船只位置

### 视觉状态同步
- 场景系统通过监听`GameState`的状态变化来更新视觉呈现
- 战斗系统的状态变化会触发场景系统的视觉更新
- 场景系统不包含战斗逻辑，只负责视觉表现

**详细战斗系统设计**：详见 `2.9 combat_system.md`

## 2.6.7 已移除的功能


## 2.6.8 数据模型

### 港口（Port）
- `id`: 港口唯一标识
- `name`: 港口名称
- `backgroundImage`: 背景图片资源路径
- `description`: 港口描述
- `unlocked`: 是否已解锁（玩家需要达到条件才能访问）

### 场景状态
- `currentPort`: 当前港口
- `isTransitioning`: 是否正在切换场景
- `isAtSea`: 是否在海上

## 2.6.9 与其他系统的关系

### 与导航系统的关系
- 场景系统负责视觉呈现和动画效果
- 导航系统负责计算航行进度和时间
- 两个系统协同工作：导航系统计算完成后，触发场景系统进行切换

### 与战斗系统的关系
- 场景系统负责战斗相关的视觉呈现（船只位置、动画效果）
- 战斗系统负责战斗逻辑（攻击、修复、胜负判断）
- 两个系统通过`GameState`进行状态同步
- **详细设计**：详见 `2.9 combat_system.md`

### 与昼夜系统的关系
- 场景系统的天体层（Layer 0.5）显示太阳/月亮
- 昼夜系统计算天体的位置和透明度
- 两个系统协同工作：昼夜系统更新状态，场景系统更新视觉
- **详细设计**：详见 `2.8 day_night_system.md`

