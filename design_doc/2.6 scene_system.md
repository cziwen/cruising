# 2.6 场景系统（Scene System）

## 2.6.1 概述
场景系统负责管理游戏的视觉呈现，采用7层渲染架构，通过切换背景层来表现不同的港口场景。船永远保持在屏幕中央，通过背景切换来表现"航行"到不同港口的效果。

**注意**：场景系统只负责视觉呈现和动画效果，不包含游戏逻辑。战斗相关的逻辑和状态管理请参考 `2.9 combat_system.md`。

## 2.6.2 核心要素

### 单场景设计
- **固定场景**：游戏始终在同一场景中进行
- **船居中**：船只永远固定在屏幕中央，不移动
- **背景切换**：通过切换近背景层来表现不同的港口场景
- **无物理效果**：移除所有物理模拟（重力、浮力、波浪、风力等）

### 7层渲染系统

#### 背景层（Layer 0）
- **内容**：远距离背景元素
- **特点**：静态或缓慢移动（如云朵飘动）
- **元素**：天空、远山、云朵、海洋背景等
- **切换**：一般不切换，或根据时间/天气缓慢变化
- **实现**：`BackgroundLayer`

#### 天体层（Layer 0.5）
- **内容**：太阳/月亮等天体元素
- **特点**：根据昼夜系统动态显示
- **独立**：独立于岛屿动画
- **实现**：`CelestialLayer`
- **参考**：详见 `2.8 day_night_system.md`（天体位置计算）

#### 近背景层（Layer 1）
- **内容**：近距离背景元素，表现当前港口
- **特点**：根据当前港口动态切换
- **元素**：港口建筑、码头、岛屿、海岸线、其他船只等
- **切换**：点击选择新港口后，使用滑入滑出动画切换（1500ms）
- **实现**：`NearBackgroundLayer`

#### 船层（Layer 2）
- **内容**：玩家的船只和敌方船只（战斗时）
- **特点**：正常状态下玩家船只永远居中，战斗时玩家船只左移，敌方船只从右侧滑入
- **位置**：屏幕中央固定位置（正常状态），战斗时根据战斗状态调整位置
- **动画**：
  - 正常状态：可选简单动画（如轻微呼吸效果、轻微摇摆），但无物理效果
  - 战斗状态：玩家船只左移，敌方船只滑入，沉船动画等（详见 `2.9 combat_system.md`）
- **实现**：`ShipLayer`

#### 屏幕效果层（Layer 2.5）
- **内容**：全屏视觉效果
- **特点**：位于船层之上，UI层之下，用于特殊视觉效果
- **元素**：渐变黑屏（战斗失败时）、其他全屏效果
- **动画**：使用`AnimatedContainer`实现平滑过渡（2秒）
- **交互**：始终忽略点击事件（`IgnorePointer`），仅作为视觉层
- **实现**：`ScreenEffectLayer`
- **状态**：通过`GameState.isFadeOut`控制

#### UI层（Layer 3）
- **内容**：所有界面元素
- **特点**：最顶层，覆盖其他所有层
- **元素**：按钮、菜单、信息显示、对话框、交易界面等
- **交互**：处理所有用户输入和界面交互
- **实现**：`UILayer`

#### 时间显示（Layer 3.5）
- **内容**：左上角时间显示
- **特点**：独立于其他UI元素
- **实现**：`TimeDisplay`

## 2.6.3 港口切换流程

### 港口选择
1. 玩家在港口界面 → 点击"选择目的地"按钮
2. 弹出港口选择界面 → 显示可访问的港口列表
3. 显示每个港口的信息：
   - 港口名称
   - 港口描述
   - 当前港口标记
4. 玩家选择目标港口 → 点击"出发"按钮

### 场景切换动画
1. **离开当前港口**：
   - 触发切换 → 开始滑出动画
   - 岛屿图像向左滑出屏幕
   - 显示"航行中..."提示（可选）
   
2. **航行过程**：
   - 显示海洋背景
   - 显示航行进度条
   - 隐藏所有岛屿交互按钮
   
3. **到达新港口**：
   - 新岛屿图像从右侧滑入屏幕
   - 动画时长：1500ms
   - 等待动画完成
   - 额外等待200ms确保完全入港
   
4. **更新游戏状态**：
   - 切换到新港口
   - 更新商品价格等
   - 显示所有交互按钮

## 2.6.4 系统流程
1. 玩家在港口A → 查看商品，进行交易
2. 点击"选择目的地" → 打开港口选择界面
3. 选择港口B → 点击"出发"
4. 触发导航系统 → 开始计算航行进度
5. 背景切换动画 → 近背景层从港口A切换到港口B
6. 到达港口B → 显示新港口场景，船仍在中央
7. 自动打开交易界面（可选）→ 玩家可以开始新的交易

## 2.6.5 技术实现

### 场景管理
- 使用Flutter的`Stack`组件实现多层叠加
- 每层使用独立的Widget管理
- 使用状态管理控制当前显示的港口和背景

### 背景切换动画
- 使用`SlideTransition`实现滑入滑出效果
- 切换时间：1500ms
- 使用`Curves.easeInOut`缓动曲线
- 当前岛屿向左滑出（Offset(-1.0, 0.0)）
- 新岛屿从右侧滑入（Offset(1.0, 0.0) → Offset.zero）

### 港口数据
- 每个港口有对应的背景图片资源
- 港口配置包含：名称、背景资源路径、商品价格等
- 距离定义在导航系统中管理

## 2.6.6 与战斗系统的关系

场景系统为战斗系统提供视觉呈现支持：

### 船只位置管理
- **正常状态**：玩家船只居中显示
- **战斗状态**：根据战斗系统的状态调整船只位置
  - 玩家船只：向左移动150像素（`playerShipXOffset`）
  - 敌方船只：从右侧滑入（`enemyShipXOffset`）

### 战斗动画支持
场景系统的船层（Layer 2）负责渲染战斗相关的动画：
- **敌方船只滑入**：使用`SlideTransition`实现（1500ms）
- **沉船动画**：使用`AnimationController`控制y坐标增加（2秒）
- **位置同步**：通过`GameState`的状态同步船只位置

### 视觉状态同步
- 场景系统通过监听`GameState`的状态变化来更新视觉呈现
- 战斗系统的状态变化会触发场景系统的视觉更新
- 场景系统不包含战斗逻辑，只负责视觉表现

**详细战斗系统设计**：详见 `2.9 combat_system.md`

## 2.6.7 已移除的功能


## 2.6.8 数据模型

### 港口（Port）
- `id`: 港口唯一标识
- `name`: 港口名称
- `backgroundImage`: 背景图片资源路径
- `description`: 港口描述
- `unlocked`: 是否已解锁（玩家需要达到条件才能访问）

### 场景状态
- `currentPort`: 当前港口
- `isTransitioning`: 是否正在切换场景
- `isAtSea`: 是否在海上

## 2.6.9 与其他系统的关系

### 与导航系统的关系
- 场景系统负责视觉呈现和动画效果
- 导航系统负责计算航行进度和时间
- 两个系统协同工作：导航系统计算完成后，触发场景系统进行切换

### 与战斗系统的关系
- 场景系统负责战斗相关的视觉呈现（船只位置、动画效果）
- 战斗系统负责战斗逻辑（攻击、修复、胜负判断）
- 两个系统通过`GameState`进行状态同步
- **详细设计**：详见 `2.9 combat_system.md`

### 与昼夜系统的关系
- 场景系统的天体层（Layer 0.5）显示太阳/月亮
- 昼夜系统计算天体的位置和透明度
- 两个系统协同工作：昼夜系统更新状态，场景系统更新视觉
- **详细设计**：详见 `2.8 day_night_system.md`

